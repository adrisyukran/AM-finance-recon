{% extends "base.html" %}

{% block title %}Upload File - Finance Reconciliation{% endblock %}

{% block navigation %}
<div class="nav-steps">
    <div class="step active">
        <div class="step-number">1</div>
        <span>Upload File</span>
    </div>
    <div class="step" id="step-columns">
        <div class="step-number">2</div>
        <span>Select Columns</span>
    </div>
    <div class="step">
        <div class="step-number">3</div>
        <span>Auto Match</span>
    </div>
    <div class="step">
        <div class="step-number">4</div>
        <span>Review</span>
    </div>
    <div class="step">
        <div class="step-number">5</div>
        <span>Export</span>
    </div>
</div>
{% endblock %}

{% block content %}
<div id="upload-section">
    <div class="card">
        <div class="card-header">
            üìÑ Upload Your Finance File
        </div>
        <p style="color: #6b7280; margin-bottom: 24px; font-size: 0.95em;">
            Upload a CSV or Excel file containing your expense and revenue transactions.
        </p>

        <div class="form-group">
            <label class="form-label">Select File</label>
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">‚òÅÔ∏è</div>
                <div class="upload-text">
                    <span class="upload-link">Upload a file</span> or drag and drop
                </div>
                <div class="upload-hint">CSV, XLSX, XLS up to 10MB</div>
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
            </div>
        </div>

        <div class="info-box">
            <div class="info-icon">‚ÑπÔ∏è</div>
            <div class="info-content">
                <strong>Tip:</strong> Make sure your file has a column with transaction amounts (positive for revenue, negative for expenses) and a description column.
            </div>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 32px;">
            <button id="uploadBtn" class="btn btn-primary" onclick="uploadFile()" disabled>
                üìä Upload & Analyze File
            </button>
            <button class="btn btn-secondary" onclick="location.reload()">
                Start Over
            </button>
        </div>

        <div id="uploadLoading" class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #6b7280;">Uploading and analyzing file...</p>
        </div>
    </div>
</div>

<div id="column-selection-section" style="display: none;">
    <div class="card">
        <div class="card-header">
            üîß Select Columns for Matching
        </div>
        <p style="color: #6b7280; margin-bottom: 24px; font-size: 0.95em;">
            Select the columns that will be used for entity matching and balance calculation.
        </p>

        <div id="fileInfo" style="background: #f9fafb; padding: 16px; border-radius: 8px; margin-bottom: 24px; border: 1px solid #e5e7eb;">
            <strong style="color: #1f2937;">File:</strong> <span id="fileName" style="color: #6b7280;"></span><br>
            <strong style="color: #1f2937;">Total Columns:</strong> <span id="columnCount" style="color: #6b7280;"></span>
        </div>

        <div class="form-group">
            <label class="form-label">Amount Column:</label>
            <select id="amountColumn" class="form-control">
                <option value="">-- Select Amount Column --</option>
            </select>
            <small style="color: #6b7280; display: block; margin-top: 8px; font-size: 0.9em;">
                Column containing transaction amounts (negative for expenses, positive for revenue)
            </small>
        </div>

        <div class="form-group">
            <label class="form-label">Description Column:</label>
            <select id="descriptionColumn" class="form-control">
                <option value="">-- Select Description Column --</option>
            </select>
            <small style="color: #6b7280; display: block; margin-top: 8px; font-size: 0.9em;">
                Column containing transaction descriptions for entity matching
            </small>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 32px;">
            <button class="btn btn-primary" onclick="startMatching()">
                ‚ñ∂Ô∏è Start Matching Process
            </button>
            <button class="btn btn-secondary" onclick="location.reload()">
                Upload Different File
            </button>
        </div>

        <div id="columnLoading" class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #6b7280;">Processing transactions...</p>
        </div>
    </div>
</div>

<style>
    .upload-zone {
        border: 2px dashed #d1d5db;
        border-radius: 12px;
        padding: 48px 24px;
        text-align: center;
        background: #fafafa;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .upload-zone:hover {
        border-color: #10b981;
        background: #f0fdf4;
    }

    .upload-zone.dragover {
        border-color: #10b981;
        background: #f0fdf4;
        transform: scale(1.01);
    }

    .upload-icon {
        font-size: 3em;
        margin-bottom: 16px;
        opacity: 0.6;
    }

    .upload-text {
        font-size: 1em;
        color: #6b7280;
        margin-bottom: 8px;
    }

    .upload-link {
        color: #10b981;
        font-weight: 600;
        cursor: pointer;
    }

    .upload-link:hover {
        color: #059669;
        text-decoration: underline;
    }

    .upload-hint {
        font-size: 0.9em;
        color: #9ca3af;
    }

    .info-box {
        display: flex;
        gap: 12px;
        padding: 16px;
        background: #f0fdf4;
        border: 1px solid #d1fae5;
        border-left: 4px solid #10b981;
        border-radius: 8px;
        margin-top: 24px;
    }

    .info-icon {
        font-size: 1.3em;
        flex-shrink: 0;
    }

    .info-content {
        color: #065f46;
        font-size: 0.95em;
        line-height: 1.5;
    }

    .info-content strong {
        font-weight: 600;
    }
</style>

<script>
    // Get elements
    const fileInput = document.getElementById('fileInput');
    const uploadZone = document.getElementById('uploadZone');
    const uploadBtn = document.getElementById('uploadBtn');

    // Click to upload
    uploadZone.addEventListener('click', () => {
        fileInput.click();
    });

    // File input change
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            uploadBtn.disabled = false;
            const fileName = e.target.files[0].name;
            uploadZone.querySelector('.upload-text').innerHTML = 
                `<span class="upload-link">${fileName}</span> selected`;
        }
    });

    // Drag and drop handlers
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadZone.addEventListener(eventName, () => {
            uploadZone.classList.add('dragover');
        });
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, () => {
            uploadZone.classList.remove('dragover');
        });
    });

    uploadZone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;

        if (files.length > 0) {
            fileInput.files = files;
            uploadBtn.disabled = false;
            const fileName = files[0].name;
            uploadZone.querySelector('.upload-text').innerHTML = 
                `<span class="upload-link">${fileName}</span> selected`;
        }
    });

    async function uploadFile() {
        const file = fileInput.files[0];

        if (!file) {
            showAlert('Please select a file', 'error');
            return;
        }

        // Show loading
        showLoading('uploadLoading');
        uploadBtn.disabled = true;

        // Create form data
        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                // Hide upload section
                document.getElementById('upload-section').style.display = 'none';

                // Show column selection
                document.getElementById('column-selection-section').style.display = 'block';

                // Update step indicator
                document.getElementById('step-columns').classList.add('active');

                // Populate column dropdowns
                populateColumns(data.columns, data.suggested_amount, data.suggested_description);

                // Update file info
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('columnCount').textContent = data.columns.length;

                showAlert(data.message, 'success');
            } else {
                showAlert(data.message, 'error');
                uploadBtn.disabled = false;
            }
        } catch (error) {
            showAlert('Error uploading file: ' + error.message, 'error');
            uploadBtn.disabled = false;
        } finally {
            hideLoading('uploadLoading');
        }
    }

    function populateColumns(columns, suggestedAmount, suggestedDescription) {
        const amountSelect = document.getElementById('amountColumn');
        const descriptionSelect = document.getElementById('descriptionColumn');

        // Clear existing options except the first one
        amountSelect.innerHTML = '<option value="">-- Select Amount Column --</option>';
        descriptionSelect.innerHTML = '<option value="">-- Select Description Column --</option>';

        // Add column options
        columns.forEach(col => {
            // Amount column option
            const amountOption = document.createElement('option');
            amountOption.value = col;
            amountOption.textContent = col;
            if (col === suggestedAmount) {
                amountOption.selected = true;
                amountOption.textContent += ' (Suggested)';
            }
            amountSelect.appendChild(amountOption);

            // Description column option
            const descOption = document.createElement('option');
            descOption.value = col;
            descOption.textContent = col;
            if (col === suggestedDescription) {
                descOption.selected = true;
                descOption.textContent += ' (Suggested)';
            }
            descriptionSelect.appendChild(descOption);
        });
    }

    async function startMatching() {
        const amountColumn = document.getElementById('amountColumn').value;
        const descriptionColumn = document.getElementById('descriptionColumn').value;

        if (!amountColumn || !descriptionColumn) {
            showAlert('Please select both Amount and Description columns', 'error');
            return;
        }

        if (amountColumn === descriptionColumn) {
            showAlert('Amount and Description columns must be different', 'error');
            return;
        }

        // Show loading
        showLoading('columnLoading');

        try {
            // Send column selection
            const selectResponse = await fetch('/select_columns', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    amount_column: amountColumn,
                    description_column: descriptionColumn
                })
            });

            const selectData = await selectResponse.json();

            if (!selectData.success) {
                showAlert(selectData.message, 'error');
                hideLoading('columnLoading');
                return;
            }

            // Start auto matching
            const matchResponse = await fetch('/auto_match', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const matchData = await matchResponse.json();

            if (matchData.success) {
                // Store match results and redirect
                sessionStorage.setItem('matchResults', JSON.stringify(matchData));
                window.location.href = '/matching';
            } else {
                showAlert(matchData.message, 'error');
            }
        } catch (error) {
            showAlert('Error processing: ' + error.message, 'error');
        } finally {
            hideLoading('columnLoading');
        }
    }
</script>
{% endblock %}
